name: Build LaTeX CV

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install TeX Live and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            fonts-font-awesome \
            biber \
            latexmk

      - name: Ensure minimal bibliography file (no changes to cv.tex)
        # Create an empty citations.bib if it doesn't exist so bibliography tools
        # don't bail with "missing .bbl" when a .bcf/.aux references nothing.
        run: |
          if [ ! -f citations.bib ]; then
            echo "% Empty bibliography (created by CI) to avoid missing bbl errors" > citations.bib
          fi

      - name: Clean previous build artifacts
        run: |
          rm -f cv.aux cv.bbl cv.bcf cv.blg cv.fdb_latexmk cv.fls cv.log cv.out cv.run.xml cv.toc \
                cv.bcf-SAVE-ERROR cv.bbl-SAVE-ERROR cv.pdf

      - name: Compile LaTeX document with xelatex (tolerate non-zero latexmk exit if PDF exists)
        run: |
          # Run latexmk explicitly with xelatex. If latexmk exits non-zero we do not let the step
          # fail immediately — instead we check for the produced PDF and show logs for debugging.
          set -o pipefail
          latexmk -xelatex -pdf -file-line-error -interaction=nonstopmode cv.tex || true
          if [ ! -f cv.pdf ]; then
            echo "❌ cv.pdf was NOT generated. Showing cv.log for debugging:"
            if [ -f cv.log ]; then
              sed -n '1,200p' cv.log || true
            else
              echo "cv.log not found"
            fi
            exit 1
          else
            echo "✅ cv.pdf generated"
            ls -lh cv.pdf
          fi

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: false